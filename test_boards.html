<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>Chessboard</title>
    <link rel="stylesheet" href="css/chessboard-0.3.0.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="js/chessboard-0.3.0.min.js"></script>
  </head>
  <body>
    <div id="board-list"></div>
  </body>

  <script>
    function getFromUrl(url, callback){
      $.ajax({
        url: `http://localhost:8080/${url}`,
        method: 'get',
        success: (r) => {
          callback(JSON.parse(r));
        },
      })
    }
    function postToUrl(url, data, callback) {
      $.ajax({
        url: `http://localhost:8080/${url}`,
        data,
        method: 'post',
        success: (r) => {
          callback(JSON.parse(r));
        },
      })
    }

    function getBoardFromIdx(idx) {
      return document.getElementById(`board-${idx}`);
    }

    function highlightColor(id, square, color) {
      $(`#board-${id} [data-square=${square}]`).addClass(`highlight-${color}`)
    }
    function removeHighlighting(id) {
      $(`#board-${id} .square-55d63`).removeClass(`highlight-yellow`)
      $(`#board-${id} .square-55d63`).removeClass(`highlight-blue`)
    }
    function highlightNextMoves(id, square, nextMoves) {
      highlightColor(id, square, 'blue')
      nextMoves = nextMoves || []
      nextMoves.forEach( ({Move, WouldCauseCheck}) => {
        if (WouldCauseCheck) {
          highlightColor(id, Move, 'red')
        } else {
          highlightColor(id, Move, 'yellow')
        }
      })
    }


    function printAllNextMoves(response) {
      response.forEach( (pieceMoves, idx) => {
        const moves = pieceMoves.Moves || [];
        console.log( `TestCasePseudoMoves{"${pieceMoves['Fen']}", "${pieceMoves['Square']}", []string{ ${moves.map( ({Move, WouldCauseCheck}) => '"' + Move + '", ').join(' ') } }},`)
        createBoardFromFen(pieceMoves['Fen'], idx);
        highlightNextMoves(idx, pieceMoves['Square'], moves)
      });
    }

    function printAllBoards(response) {
      response.forEach( (fenString, idx) => {
        createBoardFromFen(fenString, idx);
      })
    }
    var onDragStart = function(source, piece, position, orientation) {
      console.log("Drag started:");
      console.log("Source: " + source);
      console.log("Piece: " + piece);
      console.log("Position: " + ChessBoard.objToFen(position));
      console.log("Orientation: " + orientation);
    };
    function createBoardFromFen(fen, idx) {
      var cfg = {
        draggable: true,
        position: fen,
        onDragStart: (source, piece, position, orientation) => {
          onDragStart(source, piece, position, orientation)
          postToUrl('tests', {id: idx, square: source, PostType: "NextMoves"}, (r) => {
            removeHighlighting(idx)
            highlightNextMoves(idx, r.Square, r.Moves)
          })
        },
        sparePieces: true
      };
      const bdiv = document.createElement("div");
      bdiv.setAttribute("id", `board-${idx}`);
      bdiv.setAttribute("style", "width: 200px");
      $("#board-list").append(bdiv)
      ChessBoard(document.getElementById(`board-${idx}`), cfg);
      return `board-${idx}`;
    }
    // getFromUrl('GetFens', printAllBoards)
    getFromUrl('GetMoves', printAllNextMoves)
    // getFromUrl('tests', printAllBoards)
  </script>
</html>
